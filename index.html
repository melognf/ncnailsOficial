<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon-180.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<meta name="theme-color" content="#e6b8d8">
<!-- opcional iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="NC Nails">

  <title>Reserva de Turno - Manicur√≠a</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 2rem;
      background: #ded5bd;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
      input,
      select,
      textarea,
      button {
        width: 100% !important;
        box-sizing: border-box;
      }
      .horarios {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    h2 {
      color: #6d685a;
      text-align: center;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input,
    select,
    textarea {
      padding: 10px;
      width: 100%;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1em;
      transition: border 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #6d685a;
      box-shadow: 0 0 5px #000;
      outline: none;
    }
    .horarios {
     display: none; /* Oculto por defecto */
     grid-template-columns: repeat(4, 1fr);
     gap: 10px;
     margin-top: 15px;
    }

    .horario-btn {
      padding: 8px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      font-size: 0.9em;
      transition: all 0.3s ease;
      user-select: none;
    }
    .horario-btn:hover {
      background-color: #e6dce3;
      transform: scale(1.05);
    }
    .horario-btn.selected {
      background-color: #6d685a;
      color: white;
      font-weight: bold;
      transform: scale(1.08);
    }
    #aplicarHorario,
    #editarTurnoBtn {
      margin-top: 10px;
      background-color: #6d685a;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: none;
      font-size: 0.9em;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    #aplicarHorario:hover,
    #editarTurnoBtn:hover {
      background-color: #6d685a;
      transform: scale(1.05);
    }
    button[type="submit"] {
      background-color: #6d685a;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button[type="submit"]:hover {
      transform: scale(1.03);
    }
    .success-message {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #000;
      color: #ffffff;
      border: 1px solid #d0e9c6;
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      position: relative;
    }
    .success-message.show {
      opacity: 1;
      transform: translateY(0);
    }
    .success-message.hidden {
      display: none;
    }
    .success-message .checkmark {
      font-size: 1.8rem;
      margin-right: 10px;
      color: #605b4f;
    }
    .success-message .close-msg {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #6d685a;
      cursor: pointer;
      margin-left: 15px;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .logo-container img {
      width: 100%;
      max-width: 300px;
      height: auto;
      display: block;
      margin: 0 auto;
      border-radius: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .btn {
    padding: 10px 20px;
    margin: 5px;
    background-color: #ff69b4;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
  }

  .vista-toggle {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
  }

  .botones-superiores {
  display: flex;
  width: 100%;
}

.btn-superior {
  flex: 1;
  padding: 1.7rem;
  font-size: 1rem;
  background-color: #ffffff;
  color: #6d685a;
  border: 1px solid #6d685a;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
}


@media (max-width: 600px) {
  .btn-superior {
    flex: 1 1 48%;
  }
}

.btn-superior.activo {
  background-color: #6d685a;
  color: #ffffff;
  border: none;
}

.gris {
  color: #6d685a;
}

@media (max-width: 600px) {
  .horarios {
    grid-template-columns: repeat(3, 1fr);
  }

  .horario-btn {
    font-size: 0.95em;
    padding: 10px;
  }
}

/* estados de horario */
.horario { cursor: pointer; }
.horario.sel { outline: 2px solid #a78bfa; background: #eef2ff; }    /* seleccionado */
.horario.ocupado { opacity: .45; pointer-events: none; position: relative; } /* ya tomado */
.horario.ocupado::after {
  content: "Ocupado";
  position: absolute; right: 8px; top: 6px;
  font-size: 11px; background: #111827; color: #fff; padding: 2px 6px; border-radius: 999px;
}


  </style>
</head>
<body>

  <div class="logo-container">
    <img src="imagenes/nc nails.jpg" alt="Logo de la empresa" />
  </div>

  <div class="botones-superiores">
  <button class="btn-superior activo" id="btnReservas">Reservas</button>
  <button class="btn-superior" id="btnPrecios">Info, Precios y Ubicaci√≥n</button>
</div>


<div class="container" id="vistaReservas">
    <h2>Reserva tu turno</h2>
    <form id="formTurno">
      <label for="nombre">Nombre completo:</label>
      <input type="text" id="nombre" required />

      <label for="telefono">Tel√©fono / WhatsApp:</label>
      <input type="tel" id="telefono" required />

      <label for="servicio">Seleccion√° el servicio:</label>
      <select id="servicio" required>
        <option value="">-- Eleg√≠ una opci√≥n --</option>
        <option value="Manicur√≠a tradicional - $3000">Manicur√≠a tradicional - $3000</option>
        <option value="Manicur√≠a + esmaltado tradicional - $6500">Manicur√≠a + esmaltado tradicional - $6500</option>
        <option value="Manicur√≠a + esmaltado semipermanente - $10500">Manicur√≠a + esmaltado semipermanente - $10500</option>
        <option value="Capping con base rubber + esmaltado semipermanente hasta largo 2 $13000">Capping con base rubber + esmaltado semipermanente hasta largo 2- $13000</option>
        <option value="Capping en acrygel/gel + esmaltado semipermanente hasta largo 2 - $13500">Capping en acrygel/gel + esmaltado semipermanente hasta largo 2 - $13500</option>
        <option value="Extensiones en Soft Gel hasta largo 3 - $15500">Extensiones en Soft Gel hasta largo 3 - $15500</option>
        <option value="Esculpidas hasta largo 2 - $16000">Esculpidas hasta largo 2 - $16000</option>
        <option value="Retiro de esmaltado semipermante de otro sal√≥n - $3000">Retiro de esmaltado semipermante de otro sal√≥n - $3000</option>
         <option value="Retiro de capping de otro sal√≥n - $4000">Retiro de capping de otro sal√≥n - $4000</option>
        <option value="Retiro de esculpidas/Soft gel de otro sal√≥n - $4500">Retiro de esculpidas/Soft gel de otro sal√≥n - $4500</option>
      </select>

      <label for="fecha">Seleccion√° la fecha:</label>
      <input type="date" id="fecha" required />

      <div class="horarios" id="horarios"></div>
      
      <p id="detalleSeleccion" style="margin-top: 10px; font-weight: bold; color: #000;"></p>

      <label class="gris" for="mensaje">Mensaje adicional (opcional):</label>
      <textarea id="mensaje" rows="2"></textarea>

      <button type="submit">Enviar RESERVA por WhatsApp</button>
    </form>

    <div id="confirmacion" class="success-message hidden">
      <span class="checkmark">‚úî</span>
      <div>
        <strong>¬°Turno agendado!</strong><br />
        Me comunicar√© con vos para confirmar tu reserva üíÖ
      </div>
      <button class="close-msg" onclick="cerrarConfirmacion()">√ó</button>
    </div>
</div>

<div class="container" id="vistaPrecios" style="display: none;">
  <h2>Info, Precios y Ubicaci√≥n</h2>
  <p><strong>Direcci√≥n:</strong> Berl√≠n 1405, Loma Hermosa (port√≥n negro)</p>
  <p><strong>Horarios de atenci√≥n:</strong> Lunes a S√°bado de 08:30 a 18:00</p>

  <h3>Precios</h3>
  <ul>
    <li>Manicur√≠a tradicional - $3000</li>
    <li>Manicur√≠a + esmaltado tradicional - $6500</li>
    <li>Manicur√≠a + esmaltado semipermanente - $10500</li>
    <li>Capping con base rubber + esmaltado semipermante hasta largo 2 - $13000</li>
    <li>Capping en acrygel/gel + esmaltado semipermanente hasta largo 2 - $13500</li>
    <li>Extensiones en Soft Gel hasta largo 3 - $15500</li>
    <li>Esculpidas hasta largo 2 - $16000</li>
    <li>Retiro de esmaltado semipermante de otro sal√≥n - $3000</li>
    <li>Retiro de capping de otro sal√≥n - $4000</li>
    <li>Retiro de esculpidas/Soft gel de otro sal√≥n - $4500</li>
  </ul>

  <h3>Ubicaci√≥n en el mapa</h3>
  <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3285.4858767465594!2d-58.61140398925331!3d-34.56657047285484!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bcb92fd12cd157%3A0xb9bc557f3db0a0b3!2sNC%20nails!5e0!3m2!1ses!2sar!4v1747609405275!5m2!1ses!2sar" width="100%" height="300" style="border:0; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" allowfullscreen=""
    loading="lazy"
    referrerpolicy="no-referrer-when-downgrade"></iframe>
</div>

<div class="container" id="vistaInfo" style="display: none;">
  
</div>
<script type="module" src="./firebase-config.js?v=1"></script>

<script type="module">
// ==== Tabs (Reservas / Precios) ‚Äî primero para que siempre funcionen ====
const btnReservas   = document.getElementById('btnReservas');
const btnPrecios    = document.getElementById('btnPrecios');
const vistaReservas = document.getElementById('vistaReservas');
const vistaPrecios  = document.getElementById('vistaPrecios');

function setTab(tab) {
  const esReservas = (tab === 'reservas');
  vistaReservas.style.display = esReservas ? '' : 'none';
  vistaPrecios.style.display  = esReservas ? 'none' : '';
  btnReservas.classList.toggle('activo', esReservas);
  btnPrecios.classList.toggle('activo', !esReservas);
  try { localStorage.setItem('activeTab', esReservas ? 'reservas' : 'precios'); } catch(_) {}
  history.replaceState(null, '', '#' + (esReservas ? 'reservas' : 'precios'));
}
btnReservas.addEventListener('click', () => setTab('reservas'));
btnPrecios.addEventListener('click',   () => setTab('precios'));
(() => {
  const fromHash = location.hash.replace('#','');
  let start = (fromHash === 'precios' || fromHash === 'reservas') ? fromHash : null;
  if (!start) { try { start = localStorage.getItem('activeTab'); } catch(_) {} }
  setTab(start === 'precios' ? 'precios' : 'reservas');
})();

// ==== CONFIG ====
const SLOT_MIN = 15;
const DURATION_MIN = 180; // 3 horas

// ==== REFS ====
const fechaInput       = document.getElementById("fecha");
const horariosDiv      = document.getElementById("horarios");
const detalleSeleccion = document.getElementById("detalleSeleccion");
const nombreInput      = document.getElementById("nombre");
const telefonoInput    = document.getElementById("telefono");
const servicioSelect   = document.getElementById("servicio");
const mensajeInput     = document.getElementById("mensaje");
const form             = document.getElementById("formTurno");
const confirmacionDiv  = document.getElementById("confirmacion");

// Estado
let horarioSeleccionado = null;
let unsubscribeSlots    = null;
let ocupadasSetActual   = new Set();

// ==== Helpers ====
const pad2 = n => String(n).padStart(2,"0");
const normFecha = f => (f && f.includes('/')) ? f.split('/').map(x=>x.padStart(2,'0')).reverse().join('-') : f;
const normHora  = h => { const m = String(h||'').match(/^(\d{1,2})(?::?(\d{2}))?$/); return m ? `${pad2(m[1])}:${pad2(m[2] ?? '00')}` : String(h||''); };
const fechaDDMMYYYY = iso => { if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
const hmToMin = hm => { const [H,M]=hm.split(':').map(Number); return H*60+(M||0); };
const minToHM = min => `${pad2(Math.floor(min/60))}:${pad2(min%60)}`;
const addMin  = (hm,a) => minToHM(hmToMin(hm)+a);

const slotsAReservar = (horaInicio) => {
  const start = hmToMin(normHora(horaInicio));
  const count = Math.ceil(DURATION_MIN / SLOT_MIN);
  return Array.from({length:count},(_,i)=>minToHM(start+i*SLOT_MIN));
};

function clusterContiguo(hm) {
  hm = normHora(hm);
  if (!ocupadasSetActual.has(hm)) return [];
  let start = hm, end = hm;
  while (ocupadasSetActual.has(addMin(start, -SLOT_MIN))) start = addMin(start, -SLOT_MIN);
  while (ocupadasSetActual.has(addMin(end,   SLOT_MIN))) end   = addMin(end,   SLOT_MIN);
  const out=[]; for(let t=hmToMin(start); t<=hmToMin(end); t+=SLOT_MIN) out.push(minToHM(t));
  return out;
}

// Firestore (lazy)
let FB=null;
async function fb(){ if(FB) return FB; FB = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'); return FB; }

// ==== UI ====
function construirGrilla() {
  horariosDiv.innerHTML = "";
  horarioSeleccionado = null;
  detalleSeleccion.textContent = "";

  const fechaValor = fechaInput.value;
  if (!fechaValor) { horariosDiv.style.display = "none"; return; }

  const fObj = new Date(fechaValor+"T00:00:00");
  if (fObj.getDay()===0) { alert("Los domingos no hay turnos disponibles."); fechaInput.value=""; horariosDiv.style.display="none"; return; }

  horariosDiv.style.display = "grid";
  const inicio = 8*60+30, fin = 18*60; // 08:30 ‚Üí 18:00
  for (let min=inicio; min<=fin; min+=15){
    const h=pad2(Math.floor(min/60)), m=pad2(min%60), horaTxt=`${h}:${m}`;
    const btn=document.createElement("div");
    btn.textContent = horaTxt;
    btn.dataset.horaOriginal = horaTxt;
    btn.classList.add("horario-btn");

    btn.addEventListener("click", async () => {
      const fechaISO = normFecha(fechaInput.value);
      const esOcupado = btn.classList.contains('ocupado');

      // Borrado r√°pido de bloque(s) ocupados
      if (esOcupado) {
        const cluster = clusterContiguo(horaTxt);
        if (!cluster.length) return;
        const inicioC = cluster[0], finC = cluster[cluster.length-1];
        const ok = confirm(`¬øLiberar ${cluster.length} bloques?\nDesde ${inicioC} hasta ${finC}.`);
        if (!ok) return;
        try {
          const { getFirestore, writeBatch, doc } = await fb();
          const db = getFirestore();
          const batch = writeBatch(db);
          for (const hm of cluster) batch.delete(doc(db,'slots',`${fechaISO}T${hm}`));
          await batch.commit();
        } catch (e) {
          console.error('No se pudo borrar:', e);
          alert('No se pudo borrar. Public√° las reglas con delete en /slots.');
        }
        return;
      }

      // Selecci√≥n normal (SIN "Aplicar")
      document.querySelectorAll(".horario-btn").forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      horarioSeleccionado = horaTxt;

      const fBonita = fechaDDMMYYYY(fechaInput.value);
      detalleSeleccion.textContent = `Vas a enviar una reserva para el ${fBonita} a las ${horarioSeleccionado}.`;
    });

    horariosDiv.appendChild(btn);
  }
}

function marcarOcupadosUI(ocupadasSet){
  ocupadasSetActual = ocupadasSet;
  document.querySelectorAll(".horario-btn").forEach(btn=>{
    const hora = normHora(btn.dataset.horaOriginal || btn.textContent.trim());
    if (ocupadasSet.has(hora)){
      btn.classList.add("ocupado");
      btn.textContent = "OCUPADO";
      btn.style.backgroundColor = "#000";
      btn.style.color = "#fff";
      btn.style.cursor = "pointer"; // importante para poder borrar
      btn.title = "Click para liberar";
      if (btn.classList.contains("selected")){
        btn.classList.remove("selected");
        horarioSeleccionado = null;
        detalleSeleccion.textContent = "";
      }
    } else {
      btn.classList.remove("ocupado");
      btn.textContent = btn.dataset.horaOriginal || hora;
      btn.style.backgroundColor = "";
      btn.style.color = "";
      btn.style.cursor = "pointer";
      btn.title = "";
    }
  });
}

// ==== Firestore realtime ====
async function watchSlots(fechaISO){
  if (unsubscribeSlots){ unsubscribeSlots(); unsubscribeSlots=null; }
  if (!fechaISO) return;
  const { getFirestore, collection, query, where, onSnapshot } = await fb();
  const db = getFirestore();
  const q = query(collection(db,'slots'), where('fecha','==', fechaISO));
  unsubscribeSlots = onSnapshot(q, snap=>{
    const ocupadas=new Set();
    snap.forEach(d=>{ const h=d.data()?.hora; if(h) ocupadas.add(normHora(h)); });
    marcarOcupadosUI(ocupadas);
  }, err=>console.error('onSnapshot slots error:', err));
}

// ==== Eventos ====
fechaInput.addEventListener("change", ()=>{
  const f = normFecha(fechaInput.value);
  construirGrilla();
  watchSlots(f);
});

form.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if (!horarioSeleccionado){
    alert("Seleccion√° un horario primero.");
    return;
  }
  if (!nombreInput.value.trim() || !telefonoInput.value.trim() || !servicioSelect.value || !fechaInput.value){
    alert("Complet√° todos los datos requeridos.");
    return;
  }

  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  const oldLabel = submitBtn.textContent;
  submitBtn.textContent = "Enviando...";

  const fecha = normFecha(fechaInput.value);
  const hora  = normHora(horarioSeleccionado);
  const payload = {
    nombre: nombreInput.value.trim(),
    telefono: telefonoInput.value.trim(),
    servicio: servicioSelect.value,
    fecha, hora,
    mensaje: (mensajeInput.value || '').trim()
  };
  const horasABloquear = slotsAReservar(hora);

  try{
    const { getFirestore, collection, doc, runTransaction, serverTimestamp } = await fb();
    const db = getFirestore();
    const slotRefs = horasABloquear.map(hhmm=>doc(db,'slots',`${fecha}T${hhmm}`));
    const resRef   = doc(collection(db,'reservas'));

    await runTransaction(db, async tx=>{
      for (const sRef of slotRefs){
        const sSnap = await tx.get(sRef);
        if (sSnap.exists()) throw new Error('Horario ocupado');
      }
      tx.set(resRef, { ...payload, duracionMin: DURATION_MIN, estado:'pendiente', createdAt: serverTimestamp() });
      for (const sRef of slotRefs){
        const hhmm = sRef.id.split('T')[1];
        tx.set(sRef, { fecha, hora: hhmm, createdAt: serverTimestamp() });
      }
    });

    const msgWA =
      `Hola, soy ${payload.nombre}. Quiero reservar un turno para el ${fechaDDMMYYYY(payload.fecha)} a las ${payload.hora}.\n`+
      `Servicio: ${payload.servicio}.\n`+
      (payload.mensaje ? `Mensaje adicional: ${payload.mensaje}` : "")+`\n`+
      `Mi tel√©fono es ${payload.telefono}.`;
    const urlWhatsapp = `https://wa.me/549${1130669623}?text=${encodeURIComponent(msgWA)}`;

    mostrarConfirmacion();
    setTimeout(()=>window.open(urlWhatsapp,"_blank"),500);

    form.reset();
    detalleSeleccion.textContent = "";
    horarioSeleccionado = null;
    horariosDiv.style.display = "none";
  } catch(e){
    console.error('Error al guardar/bloquear:', e);
    const msg = (e?.code || e?.message || '').toString().toLowerCase();
    if (msg.includes('permission') || msg.includes('denied')) alert('Permiso denegado por reglas de Firestore.');
    else if (msg.includes('ocupado')) alert('Ese horario ya fue tomado. Eleg√≠ otro.');
    else alert('No se pudo guardar la reserva. Revis√° Firebase.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = oldLabel;
  }
});

function mostrarConfirmacion(){ confirmacionDiv.classList.remove("hidden"); confirmacionDiv.classList.add("show"); }
function cerrarConfirmacion(){  confirmacionDiv.classList.remove("show");   confirmacionDiv.classList.add("hidden"); }
window.cerrarConfirmacion = cerrarConfirmacion;

// INIT
construirGrilla();
if (fechaInput && fechaInput.value) watchSlots(normFecha(fechaInput.value));
</script>

</body>
</html>




